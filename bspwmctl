#!/usr/bin/env bash

# bspwmctl – Opinionated bspwm desktop setup
# Author: lukatinarelli

set -Eeuo pipefail


# Hide cursor
tput civis || true


# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[1;34m'
YELLOW='\033[1;33m'
NC='\033[0m'


# Global variables
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VERSION="0.0.0"
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
BSPWMCTL_DIR="$XDG_DATA_HOME/bspwmctl"


log()     { echo -e "${BLUE}[*]${NC} $*"; }
success() { echo -e "${GREEN}[✔]${NC} $*"; }
warn()    { echo -e "${YELLOW}[!]${NC} $*"; }
die()     { echo -e "${RED}[✖]${NC} $*" >&2; exit 1; }

if [[ $EUID -eq 0 ]]; then
  die "Do not run this script as root. Use a normal user."
fi


ctrl_c() {
  echo
  warn "Interrupted by user"
  exit 130
}

trap ctrl_c INT
trap 'tput cnorm || true' EXIT



print_help() {
  cat <<'EOF'

 ██████╗ ███████╗██████╗ ██╗    ██╗███╗   ███╗ ██████╗████████╗██╗     
 ██╔══██╗██╔════╝██╔══██╗██║    ██║████╗ ████║██╔════╝╚══██╔══╝██║     
 ██████╔╝███████╗██████╔╝██║ █╗ ██║██╔████╔██║██║        ██║   ██║     
 ██╔══██╗╚════██║██╔═══╝ ██║███╗██║██║╚██╔╝██║██║        ██║   ██║     
 ██████╔╝███████║██║     ╚███╔███╔╝██║ ╚═╝ ██║╚██████╗   ██║   ███████╗
 ╚═════╝ ╚══════╝╚═╝      ╚══╝╚══╝ ╚═╝     ╚═╝ ╚═════╝   ╚═╝   ╚══════╝

 bspwmctl – Opinionated bspwm desktop setup

 Create and manage a fully configured bspwm environment using a simple CLI.

 Usage:
   bspwmctl <command> [options]

 Commands:
   install           Install bspwm and required components
   uninstall         Remove bspwm configuration
   theme <name>      Apply a theme
   update            Update bspwmctl
   help              Show this help panel

 Options:
   -h, --help        Show help
   -v, --version     Show version

 Notes:
   This project is under active development.
   Commands and behavior may change.

 Project:
   https://github.com/lukatinarelli/bspwmctl

EOF
}


print_version() {
  echo "bspwmctl $VERSION"
}


check_os() {
  if [[ -f /etc/os-release ]]; then
    . /etc/os-release
    DISTRO_ID="${ID,,}"
  else
    die "Could not detect distro. /etc/os-release does not exist."
  fi
}



install_dependencies() {
  log "Installing dependencies for $DISTRO_ID..."

  case "$DISTRO_ID" in
    ubuntu|debian|kali|parrot)
      sudo apt update
      sudo apt install -y \
        build-essential git vim wget curl unzip \
        xcb libxcb1-dev libxcb-util0-dev libxcb-util-dev libxcb-ewmh-dev libxcb-randr0-dev \
        libxcb-icccm4-dev libxcb-keysyms1-dev libxcb-xinerama0-dev \
        libasound2-dev libxcb-xtest0-dev libxcb-shape0-dev \
        libxcb-xkb-dev libxcb-xrm-dev libxcb-cursor-dev \
        cmake cmake-data pkg-config python3-sphinx libcairo2-dev \
        libuv1-dev libgfshare-dev libpulse-dev libnl-genl-3-dev libmpdclient-dev \
        libcurl4-openssl-dev libxcb-image0-dev libxcb-composite0-dev \
        meson ninja-build libxext-dev libxcb-damage0-dev libxcb-xfixes0-dev \
        libxcb-render-util0-dev libxcb-render0-dev libxcb-present-dev \
        libxcb-glx0-dev libpixman-1-dev libdbus-1-dev libconfig-dev \
        libgl1-mesa-dev libegl-dev libpcre2-dev libpcre3-dev libev-dev uthash-dev \
        xcb-proto libx11-xcb-dev python3-xcbgen libepoxy-dev \
        rofi papirus-icon-theme
      ;;

    
    arch|manjaro|endeavouros)
      sudo pacman -Sy --noconfirm --needed \
        base-devel git vim wget curl unzip \
        libxcb xcb-util xcb-util-wm xcb-util-keysyms xcb-util-xrm xcb-util-cursor \
        cmake python-sphinx libuv cairo libpulse libmpdclient libcurl-compat \
        meson ninja libev uthash libconfig pcre2 xcb-proto python-xcbgen libepoxy \
        rofi papirus-icon-theme
      ;;

    
    fedora)
      sudo dnf makecache
      sudo dnf install -y \
        @development-tools git vim wget curl unzip \
        libxcb-devel xcb-util-devel xcb-util-wm-devel xcb-util-keysyms-devel \
        alsa-lib-devel xcb-util-xrm-devel xcb-util-cursor-devel \
        xcb-util-image-devel xcb-util-renderutil-devel \
        cmake gcc-c++ cairo-devel libuv-devel pulseaudio-libs-devel \
        libmpdclient-devel libcurl-devel wireless-tools-devel \
        meson ninja-build libev-devel libconfig-devel libX11-devel \
        libXext-devel pcre2-devel pixman-devel uthash-devel \
        mesa-libGL-devel libEGL-devel dbus-devel \
        xcb-proto libX11-xcb libepoxy-devel \
        rofi papirus-icon-theme
      ;;

    *)
      die "Unsupported distro. Supported: Ubuntu, Debian, Kali, Parrot, Arch, Manjaro, EndeavourOS, Fedora."
      ;;

  esac

  success "Dependencies installed successfully."
}


clone_or_update_repo() {
  local repo_url="$1"
  local extra_args="${2:-}"
  local repo_name

  repo_name="$(basename "$repo_url" .git)"
  mkdir -p "$BSPWMCTL_DIR"
  cd "$BSPWMCTL_DIR" || die "Cannot enter $BSPWMCTL_DIR"

  if [[ ! -d "$repo_name" ]]; then
    git clone $extra_args "$repo_url"
  else
    warn "Repo $repo_name already exists, updating..."
    cd "$repo_name" || die "Cannot enter $repo_name"
    git pull --ff-only
    cd "$BSPWMCTL_DIR" || die
  fi
}


install_bspwm() {
  log "Installing BSPWM..."

  clone_or_update_repo "https://github.com/baskerville/bspwm.git"

  cd "$BSPWMCTL_DIR/bspwm" || die "Cannot enter bspwm"

  make clean
  make
  sudo make install

  cd "$BSPWMCTL_DIR" || die

  # Create session entry
  if [[ ! -f /usr/share/xsessions/bspwm.desktop ]]; then
    log "Creating session entry..."
    sudo tee /usr/share/xsessions/bspwm.desktop > /dev/null <<'EOF'
[Desktop Entry]
Name=BSPWM
Comment=Binary Space Partitioning Window Manager
Exec=bspwm
TryExec=bspwm
Type=Application
EOF
  fi

  sudo ldconfig

  success "BSPWM installed."
}


install_sxhkd() {
  log "Installing SXHKD..."

  clone_or_update_repo "https://github.com/baskerville/sxhkd.git"

  cd "$BSPWMCTL_DIR/sxhkd" || die "Cannot enter sxhkd"

  make clean
  make
  sudo make install

  cd "$BSPWMCTL_DIR" || die

  success "SXHKD installed."
}


install_kitty() {
  log "Installing Kitty terminal..."

  case "$DISTRO_ID" in
    ubuntu|debian|kali|parrot)
      sudo apt install -y kitty
      ;;

    arch|manjaro|endeavouros)
      sudo pacman -Sy --noconfirm kitty
      ;;

    fedora)
      sudo dnf install -y kitty
      ;;

    *)
      die "Kitty not supported on this distro"
      ;;
  esac

  configure "kitty"

  success "Kitty installed."
}


install_polybar() {
  log "Installing Polybar..."

  clone_or_update_repo "https://github.com/polybar/polybar.git" --recursive

  cd "$BSPWMCTL_DIR/polybar" || die "Cannot enter polybar"

  if [[ -d "build" ]]; then
    rm -rf build
  fi
  mkdir build
  cd build || die

  cmake ..
  make -j"$(nproc)"
  sudo make install

  cd "$BSPWMCTL_DIR" || die

  configure "polybar"

  success "Polybar installed."
}


install_picom() {
  log "Installing Picom..."

  clone_or_update_repo "https://github.com/yshui/picom.git"

  cd "$BSPWMCTL_DIR/picom" || die "Cannot enter picom"

  git submodule update --init --recursive

  [[ -d build ]] && rm -rf build

  meson setup build \
    --buildtype=release \
    -Dwith_docs=false

  ninja -C build
  sudo ninja -C build install

  cd "$BSPWMCTL_DIR" || die

  success "Picom installed successfully."
}






























install_zsh()           { die "Not implemented yet: install_zsh"; }















install_powerlevel10k() { die "Not implemented yet: install_powerlevel10k"; }
















install_chrome()    { die "Not Implemented yet: install_chrome"; }
install_vscode()    { die "Not implemented yet: install_vscode"; }
install_spotify()   { die "Not implemented yet: install_spotify"; }
install_burpsuite() { die "Not implemented yet: install_burpsuite"; }


configure() {
  local target="$1"
  local config_dir="$HOME/.config/$target"

  echo -e "${GREEN}⚙️ Configuring ${target^^}...${NC}"

  mkdir -p "$config_dir"

  if [[ -d "$BSPWMCTL_DIR/config/$target" ]]; then
    cp -rf "$BSPWMCTL_DIR/config/$target/"* "$config_dir/"
  else
    die "Error: configs not found in $BSPWMCTL_DIR/config/$target"
  fi

  if [[ -f "$config_dir/${target}rc" ]]; then
    chmod +x "$config_dir/${target}rc" || true
  fi

  success "Configs copied for $target"
  echo
}


get_current_theme() {
  local current_file="$BSPWMCTL_DIR/.current_theme"

  if [[ -f "$current_file" ]]; then
    cat "$current_file"
  else
    echo "default"
  fi
}


set_current_theme() {
  local theme="$1"
  echo "$theme" > "$BSPWMCTL_DIR/.current_theme"
}


cmd_theme() {
  local theme="${1:-}"

  if [[ -z "$theme" ]]; then
    local current
    current="$(get_current_theme)"
    log "Current theme: $current"

    echo "Available themes:"
    ls "$BSPWMCTL_DIR/themes" 2>/dev/null || echo "  (no themes found)"
    return
  fi

  # apply theme logic
  log "Applying theme: $theme"

  case "$theme" in
    default)
      configure "bspwm"
      configure "sxhkd"
      configure "kitty"
      ;;
    *)
      die "Unknown theme: $theme"
      ;;
  esac

  set_current_theme "$theme"
  success "Theme applied: $theme"
}



parse_install_args() {
  MODE="standard"
  NO_DEP=false
  THEME="default"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --minimal)
        MODE="minimal"
        shift
        ;;
      --standard)
        MODE="standard"
        shift
        ;;
      --all)
        MODE="full"
        shift
        ;;
      --no-dep)
        NO_DEP=true
        shift
        ;;
      --theme)
        THEME="$2"
        shift 2
        ;;
      *)
        die "Unknown option: $1"
        ;;
    esac
  done
}


cmd_install() {
  parse_install_args "$@"

  check_os

  if [ "$NO_DEP" = false ]; then
    install_dependencies
  else
    warn "Skipping dependency installation (--no-dep). Make sure all required packages are already installed."
  fi

  case "$MODE" in
    minimal)
      install_bspwm
      install_sxhkd
      install_kitty
      ;;
    standard)
      install_bspwm
      install_sxhkd
      install_kitty
      install_polybar
      install_picom
      install_zsh
      install_powerlevel10k
      ;;
    full)
      install_bspwm
      install_sxhkd
      install_kitty
      install_polybar
      install_picom
      install_zsh
      install_powerlevel10k
      install_vscode
      install_spotify
      install_burpsuite
      ;;
    *)
      die "Unknown install mode: $MODE"
      ;;
  esac

  cmd_theme "$THEME"

  success "Installation complete!"
  success "Run: bspwmctl theme <name> to apply a theme"
}


cmd_uninstall() { die "Not implemented yet: uninstall"; }
cmd_update()    { die "Not implemented yet: update"; }



main() {
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
    install)    cmd_install "$@" ;;
    uninstall)  cmd_uninstall "$@" ;;
    theme)      cmd_theme "$@" ;;
    update)     cmd_update "$@" ;;
    help)       print_help ;;
    -h|--help)  print_help ;;
    version|-v|--version) print_version ;;
    *) die "Unknown command: $cmd" ;;
  esac
}

main "$@"
